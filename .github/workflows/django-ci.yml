name: SonarQube Scan

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  sonar:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    - name: Download ngrok
      run: |
        wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
        unzip ngrok-stable-linux-amd64.zip
        chmod +x ngrok
    - name: Start SonarQube (Docker)
      run: |
        docker run -d --name sonarqube -p 9000:9000 sonarqube:community
        sleep 60  # attendre que SonarQube dÃ©marre
    - name: Start ngrok to expose SonarQube
      run: |
        ./ngrok http 9000 --log=stdout > ngrok.log &
        sleep 10
        export SONAR_HOST_URL=$(grep -o 'https://[a-z0-9.-]*.ngrok.io' ngrok.log | head -n1)
        echo "SONAR_HOST_URL=$SONAR_HOST_URL" >> $GITHUB_ENV
    - name: Run SonarScanner
      uses: SonarSource/sonarqube-scan-action@v2
      with:
        args: >
          -Dsonar.projectKey=rsa_project
          -Dsonar.projectName=rsa_project
          -Dsonar.sources=.
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}